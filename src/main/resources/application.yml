server:
  address: ${APP_HOST:0.0.0.0}
  port: ${APP_PORT:8080}

spring:
  main:
    banner-mode: OFF

  jackson:
    time-zone: UTC

  # ================== DATASOURCE ==================
  datasource:
    username: ${DATABASE_USERNAME:login_processing_user}
    password: ${DATABASE_PASSWORD:login_processing_password}
    url: jdbc:postgresql://${POSTGRESQL_HOST:localhost}:${POSTGRESQL_PORT:5432}/${DATABASE_NAME:login_processing_db}
    driver-class-name: org.postgresql.Driver

  # ================== JPA ==================
  jpa:
    database: POSTGRESQL
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    defer-datasource-initialization: false
    show-sql: true
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        format_sql: true
      javax:
        persistence:
          create-database-schemas: true
      default_schema: ${DATABASE_SCHEMA:login_processing}

  # ================== FLYWAY ==================
  flyway:
    enabled: true
    locations: classpath:db/migration
    default-schema: ${DATABASE_SCHEMA:login_processing}
    schemas: ${DATABASE_SCHEMA:login_processing}
    create-schemas: true
    validate-on-migrate: true
    clean-disabled: true

  # ================== KAFKA ==================
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}

    consumer:
      group-id: login-processing-service
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "com.codechallenge.loginprocessingservice"
        spring.json.value.default.type: "com.codechallenge.loginprocessingservice.dto.CustomerLoginEvent"

    # OutboxPublisher باید byte[] منتشر کنه
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.ByteArraySerializer
      acks: all
      retries: 3

    listener:
      ack-mode: manual

# ================== APP CONFIG ==================
app:
  kafka:
    topic:
      input: customer-login
      output: login-tracking-result

  customer-tracking:
    base-url: ${CUSTOMER_TRACKING_BASE_URL:https://customer-tracking-service}
    username: ${CUSTOMER_TRACKING_USERNAME:tracking_user}
    password: ${CUSTOMER_TRACKING_PASSWORD:tracking_password}

  outbox:
    poll-ms: 500
    batch-size: 50
    max-retries: 10

# ================== RESILIENCE4J ==================
resilience4j:
  retry:
    instances:
      customerTracking:
        max-attempts: 3
        wait-duration: 200ms
        retry-exceptions:
          - org.springframework.web.client.ResourceAccessException
          - org.springframework.web.client.RestClientResponseException
          - org.springframework.web.client.RestClientException
        ignore-exceptions:
          - org.springframework.web.client.HttpClientErrorException

# ================== LOGGING ==================
logging:
  level:
    root: INFO
    org.flywaydb: INFO
    org.apache.kafka: INFO
    io.github.resilience4j.retry: INFO

# ================== ACTUATOR ==================
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus
  endpoint:
    health:
      show-details: always
